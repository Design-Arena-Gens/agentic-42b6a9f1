import fs from 'node:fs';
import path from 'node:path';
import pdfMake from 'pdfmake/build/pdfmake.js';
import pdfFonts from 'pdfmake/build/vfs_fonts.js';

pdfMake.vfs = pdfFonts.pdfMake.vfs;

const OUTPUT = path.resolve('public/book.pdf');

const docDefinition = {
  info: {
    title: '?????????? ?? 3 ?????? ? ??????? ? ?????',
    author: 'Auto-generated',
    subject: '????-????? ??? ???????? ??????????? ?? B2',
  },
  defaultStyle: { fontSize: 11, lineHeight: 1.25 },
  content: [
    { text: '?????????? ?? 3 ?????? ??? ?????? ? ??????', style: 'h1' },
    { text: '??????????: ??????? ? ????? ? ????: B2', style: 'sub' },
    { text: '????????: ???????, ??????, ??????? ??????????, 20 ???????? ???? ? 10 ??????????? ???? ??? ???????????? ?????? ?? ???????/??????. ? ????? ? ????????? ???? ?? 12 ??????.', margin: [0, 10, 0, 10], color: '#555' },

    { text: '????????? ?????', style: 'h2' },
    { ol: [
      '???? ?? 12 ??????',
      '??????? ??????????? ?????',
      '??????? ?????? ? ????????????',
      '??????? ?????????? ?? B1?B2',
      '20 ???????? ???? (???????/?????)',
      '10 ??????????? ??????? ????'
    ]},

    { text: '1) ???? ?? 12 ??????', style: 'h2', pageBreak: 'before' },
    { text: '????????? (45?60 ???): ?????? ? ??????? ????, 10?15 ??? ????????????, 20?30 ??? ??????????/??????????, 10?15 ??? ????? ??? ??????. ???????????: 1?2 ?????/????? (???????, ?????????? ?? ??????? ????????????), 1 ?????? ???????.' },
    { columns: [
      [
        { text: '?????? 1?2 ? ?????', style: 'h3' },
        { ul: [ '???????, ??????? ?????, ????????????', '???????????, ?????????????, ?????, ????', '??????????: to be, ??????? a/an/the' ] },
        { text: '?????? 5?6 ? ????????? ? ???????', style: 'h3', margin: [0, 10, 0, 0] },
        { ul: [ 'Past Simple, Present Perfect (????????)', 'Future (will / going to)', '???????? ?????, ????? ? ??????????' ] },
        { text: '?????? 9?10 ? ????????? B1', style: 'h3', margin: [0, 10, 0, 0] },
        { ul: [ 'Countable/Uncountable, much/many, some/any', 'Comparatives/Superlatives', 'Conditional 0/1 (??????? ????????)' ] },
      ],
      [
        { text: '?????? 3?4 ? ??????', style: 'h3' },
        { ul: [ 'Present Simple / Continuous, ???????', '???????: ???????????, ??????????, ?????', '?????????? ? ??????? ????????????' ] },
        { text: '?????? 7?8 ? ??????????', style: 'h3', margin: [0, 10, 0, 0] },
        { ul: [ '?????????: can, must, should, have to', '?????/????????: in/on/at, next to/behind', '??????? ???????, ???????, ?????????' ] },
        { text: '?????? 11?12 ? ??????????? B2', style: 'h3', margin: [0, 10, 0, 0] },
        { ul: [ '?????? ? ????-??????????', '??????? ???????: ?????, ????????, ??????????????', '????????????? ? ???????????? ?? ?????' ] },
      ]
    ]},

    { text: '2) ??????? ??????????? ?????', style: 'h2', pageBreak: 'before' },
    { text: '26 ????: A a, B b, C c, D d, E e, F f, G g, H h, I i, J j, K k, L l, M m, N n, O o, P p, Q q, R r, S s, T t, U u, V v, W w, X x, Y y, Z z.' },
    { columns: [
      [ { text: '???????', style: 'h3' },
        { ul: [
          'A a ? cat /e, ?/, name /e?/',
          'E e ? bed /e/, he /i?/',
          'I i ? sit /?/, time /a?/',
          'O o ? not /?, ??/, go /o?/',
          'U u ? cup /?/, use /ju?/'
        ] } ],
      [ { text: '?????????', style: 'h3' },
        { ul: [
          'TH ? thin /?/, this /?/',
          'CH ? chair /t?/',
          'SH ? shoe /?/',
          'PH ? phone /f/',
          'NG ? sing /?/'
        ] } ]
    ]},
    { text: '?????: ???????? ??????????? ???? (ship/sheep, cat/cut) ? ?????????? ????? ??????? ? ???????? ?????.', color: '#555', margin: [0, 8, 0, 0] },

    { text: '3) ??????? ?????? ? ???????????? (??????)', style: 'h2', pageBreak: 'before' },
    { ul: [
      'Silent e: cap ? cape; cub ? cube (?????? ??????? ?????????)',
      'R-controlled: car /k??r/, work /w??rk/',
      '????????: contract (???.) vs conTR?CT (????.)',
      '??????: get it ? getit /??et?t/ (? ?????? ????)',
      '????????: /e?/ day, /a?/ time, /o?/ go, /a?/ house'
    ]},

    { text: '4) ??????? ?????????? ?? B2 (??????? ??????????)', style: 'h2', pageBreak: 'before' },
    { table: {
        widths: ['auto','*','*'],
        body: [
          [{ text:'????', style:'th' }, { text:'??????', style:'th' }, { text:'???????', style:'th' }],
          ['To be', 'I am, You are, He/She is', '?????????, ?????????, ?????'],
          ['???????', 'a/an, the', '????? vs ??????????'],
          ['Present Simple', 'He works. Do you work?', '?????, ??????????'],
          ['Present Continuous', 'He is working now.', '???????? ??????'],
          ['Past Simple', 'He finished yesterday.', '??????????? ? ???????'],
          ['Present Perfect', 'He has finished.', '????/????????? ? ??????????'],
          ['Future', 'I will start at 7am.', '???????/????????; going to ? ????'],
          ['?????????', 'can, must, should', '???????????, ???????????, ?????'],
          ['????????', 'on site, at the warehouse', 'in/on/at, next to, behind'],
          ['??????./????????.', 'tools / equipment', 'much/many, some/any'],
          ['?????????', 'safer, the fastest', 'er/more; est/most'],
          ['???????? 0/1', 'If it rains, we stop.', '???????/???????? ???????'],
          ['?????????????', 'Wear a helmet.', '??????????/???????'],
          ['???????', 'Where should I unload?', 'Wh- + ?????. ??????'],
        ]
      }, layout: 'lightHorizontalLines' },
    { text: '????????: ?????? ???? 5?10 ???????? ??????????? ?? ???? ??????. ??????????? ? ?????????????? ?????.', color:'#555', margin:[0,8,0,0]},

    { text: '5) 20 ???????? ???? (???????/?????)', style: 'h2', pageBreak: 'before' },
    { ol: [
      'hammer ? ???????',
      'screwdriver ? ????????',
      'wrench ? ??????? ????',
      'drill ? ?????',
      'ladder ? ????????',
      'scaffold ? ???????????? ????',
      'safety helmet (hard hat) ? ?????',
      'gloves ? ????????',
      'safety boots ? ???????? ?????',
      'forklift ? ?????????',
      'pallet ? ??????',
      'warehouse ? ?????',
      'delivery ? ????????',
      'shipment ? ????????/??????',
      'inventory ? ??????????????/??????',
      'supervisor ? ????????/???????? ?????',
      'shift ? ?????',
      'overtime ? ????????????',
      'contract ? ????????',
      'payslip ? ????????? ????'
    ]},

    { text: '6) 10 ??????????? ??????? ????', style: 'h2' },
    { ol: [
      'Could you pass me the wrench, please? ? ?????????, ??????????, ????.',
      'Where should I load/unload? ? ??? ??? ???????/???????????',
      'I will start my shift at 7 am. ? ? ??????? ????? ? 7 ????.',
      'Safety first. Wear your helmet. ? ???????????? ?????? ?????. ???????? ?????.',
      'Please check the inventory. ? ??????????, ????????? ??????.',
      'The delivery arrives at noon. ? ???????? ???????? ? ???????.',
      'I need a pallet jack. ? ??? ????? ?????.',
      'The forklift is not working. ? ????????? ?? ????????.',
      'Could you show me the plan? ? ????????, ??????????, ????.',
      "I'll finish this task in 20 minutes. ? ? ??????? ??? ?????? ?? 20 ?????."
    ]},

    { text: '?????: ???????? ?????????. ?????? ???? ?????????? 5?10 ????? ???? ? 3?5 ???? ?? ????? ??????.', color:'#555', margin:[0,8,0,0]}
  ],
  styles: {
    h1: { fontSize: 22, bold: true, margin: [0, 0, 0, 6] },
    sub: { color: '#555', margin: [0, 0, 0, 10] },
    h2: { fontSize: 16, bold: true, margin: [0, 16, 0, 8] },
    h3: { fontSize: 12, bold: true, margin: [0, 8, 0, 4] },
    th: { bold: true }
  },
};

function createPdfBuffer(docDefinition) {
  return new Promise((resolve, reject) => {
    const pdfDocGenerator = pdfMake.createPdf(docDefinition);
    pdfDocGenerator.getBuffer((buffer) => {
      if (!buffer) return reject(new Error('Failed to generate buffer'));
      resolve(Buffer.from(buffer));
    });
  });
}

const outDir = path.dirname(OUTPUT);
fs.mkdirSync(outDir, { recursive: true });

createPdfBuffer(docDefinition)
  .then((buf) => fs.writeFileSync(OUTPUT, buf))
  .then(() => console.log('PDF saved to', OUTPUT))
  .catch((err) => { console.error(err); process.exit(1); });
